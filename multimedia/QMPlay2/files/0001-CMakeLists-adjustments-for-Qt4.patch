From 7503cb5a0320ab44c6b427897fffe30072ae0dd5 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Thu, 21 Nov 2024 06:54:50 +0800
Subject: [PATCH 1/8] CMakeLists: adjustments for Qt4

---
 CMakeLists.txt                        | 20 ++++++++++---
 lang/CMakeLists.txt                   |  8 +++--
 src/gui/CMakeLists.txt                | 18 +++++++----
 src/modules/Extensions/CMakeLists.txt | 14 +++++++--
 src/qmplay2/CMakeLists.txt            | 43 ++++++++++++++++++++-------
 5 files changed, 80 insertions(+), 23 deletions(-)

diff --git CMakeLists.txt CMakeLists.txt
index cd7189aa..cc2c1909 100644
--- CMakeLists.txt
+++ CMakeLists.txt
@@ -19,9 +19,13 @@ else()
     find_package(DummyPkgConfig REQUIRED)
 endif()
 
-find_package(Qt5Widgets 5.6 REQUIRED)
-if(Qt5Widgets_VERSION VERSION_LESS 5.6.3)
-    message(AUTHOR_WARNING "Qt5 >= 5.6.3, >= 5.9.1 is recommended")
+option(USE_QT4 "Build with Qt4" OFF)
+
+if(USE_QT4)
+    find_package(Qt4 REQUIRED QtCore QtGui)
+    include("${QT_USE_FILE}")
+else()
+    find_package(Qt5Widgets 5.10 REQUIRED)
 endif()
 
 set(CMAKE_LINK_DEPENDS_NO_SHARED ON)
@@ -49,6 +53,10 @@ endif()
 
 add_definitions(-D__STDC_CONSTANT_MACROS -D__STDC_LIMIT_MACROS -DQT_USE_FAST_OPERATOR_PLUS)
 
+if(APPLE AND USE_QT4)
+    add_definitions(-DQ_OS_MACOS)
+endif()
+
 if(WIN32)
     option(USE_CMD "Show CMD when running QMPlay2" OFF)
     mark_as_advanced(USE_CMD)
@@ -306,7 +314,11 @@ if(USE_MEDIABROWSER)
 endif()
 
 if(NOT ANDROID)
+  if(USE_QT4)
+    find_package(Qt4 QUIET OPTIONAL_COMPONENTS QtSvg)
+  else()
     find_package(Qt5Svg QUIET)
+  endif()
 else()
     find_package(Qt5Svg REQUIRED)
     find_package(Qt5AndroidExtras REQUIRED)
@@ -337,7 +349,7 @@ if(NOT APPLE AND NOT WIN32)
 endif()
 
 # Show warning if QtSvg doesn't exist
-if(NOT Qt5Svg_FOUND)
+if(NOT Qt5Svg_FOUND AND NOT Qt4_FOUND)
     message(WARNING "Missing QtSvg module - SVG icons will not be visible!")
 endif()
 
diff --git lang/CMakeLists.txt lang/CMakeLists.txt
index db28debd..bb5043e7 100644
--- lang/CMakeLists.txt
+++ lang/CMakeLists.txt
@@ -12,8 +12,12 @@ else()
     endforeach()
 endif()
 
-find_package(Qt5LinguistTools REQUIRED)
-qt5_add_translation(QM_FILES ${QMPLAY2_TSS})
+if(USE_QT4)
+    qt4_add_translation(QM_FILES ${QMPLAY2_TSS})
+else()
+    find_package(Qt5LinguistTools REQUIRED)
+    qt5_add_translation(QM_FILES ${QMPLAY2_TSS})
+endif()
 
 add_custom_target(translations ALL DEPENDS ${QM_FILES})
 
diff --git src/gui/CMakeLists.txt src/gui/CMakeLists.txt
index 7f8c22b5..4a097f5e 100644
--- src/gui/CMakeLists.txt
+++ src/gui/CMakeLists.txt
@@ -65,7 +65,6 @@ set(GUI_SRC
     ShortcutHandler.cpp
     KeyBindingsDialog.cpp
     Updater.cpp
-    EventFilterWorkarounds.cpp
 )
 
 set(GUI_FORMS # *.ui files
@@ -79,10 +78,15 @@ set(GUI_RESOURCES
     resources.qrc
 )
 
-if(NOT WIN32)
+if(NOT USE_QT4)
     list(APPEND GUI_SRC
-        PanGestureEventFilter.cpp
+        EventFilterWorkarounds.cpp
     )
+    if(NOT WIN32)
+        list(APPEND GUI_SRC
+            PanGestureEventFilter.cpp
+        )
+    endif()
 endif()
 
 if(APPLE)
@@ -96,7 +100,11 @@ if(APPLE)
     include_directories("macOS")
 endif()
 
-qt5_wrap_ui(GUI_FORM_HDR ${GUI_FORMS})
+if(USE_QT4)
+    qt4_wrap_ui(GUI_FORM_HDR ${GUI_FORMS})
+else()
+    qt5_wrap_ui(GUI_FORM_HDR ${GUI_FORMS})
+endif()
 set_property(SOURCE ${GUI_FORM_HDR} PROPERTY SKIP_AUTOMOC ON)
 
 include_directories(../qmplay2/headers)
@@ -121,7 +129,7 @@ if(USE_TAGLIB)
     list(APPEND GUI_SRC TagEditor.cpp)
 endif()
 
-if(NOT APPLE)
+if(USE_QT4 OR NOT APPLE)
     add_definitions(-DQMPLAY2_ALLOW_ONLY_ONE_INSTANCE)
 endif()
 
diff --git src/modules/Extensions/CMakeLists.txt src/modules/Extensions/CMakeLists.txt
index 9be7afeb..9263b6f1 100644
--- src/modules/Extensions/CMakeLists.txt
+++ src/modules/Extensions/CMakeLists.txt
@@ -55,7 +55,11 @@ if(USE_MEDIABROWSER)
     set(QML Qt5::Qml)
 endif()
 
-qt5_wrap_ui(Extensions_FORM_HDR ${Extensions_FORMS})
+if(USE_QT4)
+    qt4_wrap_ui(Extensions_FORM_HDR ${Extensions_FORMS})
+else()
+    qt5_wrap_ui(Extensions_FORM_HDR ${Extensions_FORMS})
+endif()
 set_property(SOURCE ${Extensions_FORM_HDR} PROPERTY SKIP_AUTOMOC ON)
 
 include_directories(../../qmplay2/headers
@@ -69,9 +73,15 @@ add_library(${PROJECT_NAME} ${QMPLAY2_MODULE}
     ${Extensions_RESOURCES}
 )
 
+if(USE_QT4)
+    add_definitions(-I/opt/local/include/QJson4)
+    target_link_libraries(${PROJECT_NAME} Qt4::QtCore Qt4::QtGui QJson4)
+else()
+    target_link_libraries(${PROJECT_NAME} ${QML})
+endif()
+
 target_link_libraries(${PROJECT_NAME}
     ${DBUS}
-    ${QML}
     libqmplay2
 )
 
diff --git src/qmplay2/CMakeLists.txt src/qmplay2/CMakeLists.txt
index c70bd00c..d7509e9a 100644
--- src/qmplay2/CMakeLists.txt
+++ src/qmplay2/CMakeLists.txt
@@ -112,7 +112,7 @@ if(USE_FREEDESKTOP_NOTIFICATIONS)
     qt5_add_dbus_interface(QMPLAY2_SRC org.freedesktop.Notifications.xml notifications_interface)
     add_definitions(-DNOTIFIES_FREEDESKTOP)
     set(DBUS Qt5::DBus)
-elseif(APPLE)
+elseif(APPLE AND NOT USE_QT4)
     list(APPEND QMPLAY2_HDR headers/NotifiesMacOS.hpp)
     list(APPEND QMPLAY2_SRC NotifiesMacOS.mm)
     find_package(Qt5MacExtras REQUIRED)
@@ -195,11 +195,18 @@ add_library(${PROJECT_NAME} SHARED
 set_target_properties(${PROJECT_NAME} PROPERTIES PREFIX "")
 
 if(APPLE)
-    target_link_libraries(${PROJECT_NAME}
-        PRIVATE
-        Qt5::MacExtras
-        ${APPKIT_LIBRARY}
+    if(USE_QT4)
+        target_link_libraries(${PROJECT_NAME}
+            PRIVATE
+            ${APPKIT_LIBRARY}
     )
+    else()
+        target_link_libraries(${PROJECT_NAME}
+            PRIVATE
+            Qt5::MacExtras
+            ${APPKIT_LIBRARY}
+    )
+    endif()
 endif()
 
 if(WIN32)
@@ -229,14 +236,30 @@ else()
     endif()
 endif()
 
+if(USE_QT4)
+    add_definitions(-I/opt/local/include/QJson4)
+    target_link_libraries(${PROJECT_NAME}
+        PUBLIC
+        Qt4::QtCore
+        Qt4::QtGui
+        Qt4::QtSvg
+        QJson4
+    )
+else()
+    target_link_libraries(${PROJECT_NAME}
+        PUBLIC
+        Qt5::Core
+        Qt5::Gui
+        Qt5::Widgets
+        Qt5::Svg
+        PRIVATE
+        ${QML}
+    )
+endif()
+
 target_link_libraries(${PROJECT_NAME}
-    PUBLIC
-    Qt5::Core
-    Qt5::Gui
-    Qt5::Widgets
     PRIVATE
     ${DBUS}
-    ${QML}
     ${LIBQMPLAY2_LIBS}
 )
 
-- 
2.47.0

