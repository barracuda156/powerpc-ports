From 4c65367e67419d9d34b717f5c2832d543dcd9cf8 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Fri, 29 Nov 2024 10:41:22 +0800
Subject: [PATCH 12/12] YouTubeDL: move to QJson

---
 src/modules/Extensions/MediaBrowser/ProstoPleer.cpp |  7 ++++---
 src/qmplay2/YouTubeDL.cpp                           | 12 +++++++-----
 2 files changed, 11 insertions(+), 8 deletions(-)

diff --git src/modules/Extensions/MediaBrowser/ProstoPleer.cpp src/modules/Extensions/MediaBrowser/ProstoPleer.cpp
index cb3c287d..c35bd5d2 100644
--- src/modules/Extensions/MediaBrowser/ProstoPleer.cpp
+++ src/modules/Extensions/MediaBrowser/ProstoPleer.cpp
@@ -21,9 +21,10 @@
 #include <QMPlay2Extensions.hpp>
 #include <NetworkAccess.hpp>
 #include <Functions.hpp>
-#include <Json11.hpp>
 
+#include <QJsonDocument.h>
 #include <QTextDocument>
+#include <QJsonObject.h>
 #include <QHeaderView>
 #include <QTreeWidget>
 #include <QAction>
@@ -187,8 +188,8 @@ bool ProstoPleer::convertAddress(const QString &prefix, const QString &url, cons
 				IOController<NetworkReply> &netReply = ioCtrl->toRef<NetworkReply>();
 				if (net.startAndWait(netReply, QString("%1/site_api/files/get_url?id=%2").arg(g_url, fileId.mid(idx + 1))))
 				{
-					const Json json = Json::parse(netReply->readAll());
-					const QString tmpStreamUrl = json["track_link"].string_value();
+					const QJsonDocument json = QJsonDocument::fromJson(netReply->readAll());
+					const QString tmpStreamUrl = json.object()["track_link"].toString();
 					if (!tmpStreamUrl.isEmpty())
 						*streamUrl = tmpStreamUrl;
 					netReply.clear();
diff --git src/qmplay2/YouTubeDL.cpp src/qmplay2/YouTubeDL.cpp
index 98071fea..81185596 100644
--- src/qmplay2/YouTubeDL.cpp
+++ src/qmplay2/YouTubeDL.cpp
@@ -26,6 +26,9 @@
 
 #include <QRegExp>
 #include <QReadWriteLock>
+#include <QJsonDocument.h>
+#include <QJsonObject.h>
+#include <QJsonArray.h>
 #include <QFile>
 
 constexpr char g_name[] = "YouTubeDL";
@@ -36,12 +39,11 @@ static QReadWriteLock g_lock;
 
 static void exportCookiesFromJSON(const QString &jsonData, const QString &url)
 {
-	const Json json = Json::parse(jsonData.toUtf8());
-	const QByteArray urlData = url.toUtf8();
-	for (const Json &formats : json["formats"].array_items())
+	const QJsonDocument json = QJsonDocument::fromJson(jsonData.toUtf8());
+	for (const QJsonValue &formats : json.object()["formats"].toArray())
 	{
-		if (urlData == formats["url"].string_value())
-			QMPlay2Core.addCookies(url, formats["http_headers"]["Cookie"].string_value());
+		if (url == formats.toObject()["url"].toString())
+			QMPlay2Core.addCookies(url, formats.toObject()["http_headers"].toObject()["Cookie"].toString().toUtf8());
 	}
 }
 
-- 
2.47.1

